<!DOCTYPE HTML>
<html>
    <head>
        <title>MyBristol | Bristol Digital Challenge</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<meta name="author" content="" /> 
		<meta name="description" content="" /> 
		<meta name="keywords" content="" />
		<link rel="shortcut icon" type="image/png" href="" />
		<!-- PAGE CSS -->
        <link rel="stylesheet" type="text/css" href="css/fonts.css">
        <link rel="stylesheet" type="text/css" href="css/index.css">      
        <!--<link rel="stylesheet" type="text/css" href="css/perfect-scrollbar.min.css">-->   
  </head>
  <body>
    <div id="top-menu">
        <div id="default-menu">
            <div id="menu-button" class="circular-button"><img src="img/menu-icon.png" alt="Menu icon" /></div>
            <div id="draw-button" class="circular-button"><img src="img/draw-icon.png" alt="Draw icon" /></div>
            <div class="clearfix"></div>
        </div>
        <div id="draw-menu">
            <div id="cancel-button" class="circular-button"><img src="img/cross-icon.png" alt="Cross icon" /></div>
            <div id="area-left"></div>
            <div id="submit-button" class="circular-button"><img src="img/check-icon.png" alt="Submit icon" /></div>        
            <div id="undo-button" class="circular-button"><img src="img/undo-icon.png" alt="Undo icon" /></div>
        </div>
    </div>
    <div id="draw-types">
        <div class="ind-draw draw-active" id="pan-map" title="Pan map"><img src="img/draw/hand-icon.png" alt="Hand icon" /></div>        
        <div class="ind-draw" id="draw-trees" title="Trees"><img src="img/draw/trees-icon.png" alt="Trees icon" /></div>
        <div class="ind-draw" id="draw-flowers" title="Flowers"><img src="img/draw/flowers-icon.png" alt="Flowers icon" /></div>
        <div class="ind-draw" id="draw-park" title="Park"><img src="img/draw/park-icon.png" alt="Park icon" /></div>
        <div class="clearfix"></div>
    </div>
    <div id="map-canvas"></div>
    <script src="js/jquery-1.11.2.min.js"></script>
    <script src="http://www.bdcc.co.uk/Gmaps/GDouglasPeuker.js"></script>
    <!--<script src="js/perfect-scrollbar.min.js"></script>-->
    <script src="https://maps.googleapis.com/maps/api/js?libraries=drawing"></script>
    <script>
    
    var map;
    var colours = ['#47d282', '#dd6ca2', '#f4d248'];
    var selectedColour = 0;
    var polygonArray = [];
    var permanentPolygons = [];
    
    function initialize() {
        
        var mapOptions = {
            center: new google.maps.LatLng(51.45, -2.6),
            zoom: 14,
            disableDefaultUI: true,
            styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }]}]
        };
        
        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
       
    }
    
    google.maps.event.addDomListener(window, 'load', initialize);
    
    function drawFreeHand(){

        var polyline = new google.maps.Polyline({ map: map, clickable: false, strokeColor: colours[selectedColour] });
    
        // move listener
        var move = google.maps.event.addListener(map, 'mousemove', function(e){
            polyline.getPath().push(e.latLng);
        });
    
        //mouseup listener
        google.maps.event.addListenerOnce(map, 'mouseup', function(e){
            google.maps.event.removeListener(move);
            var path = polyline.getPath();
            polyline.setMap(null);             

            var polygon = new google.maps.Polygon({
                map: map,
                fillColor: colours[selectedColour],
                fillOpacity: 0.7,
                strokeColor: colours[selectedColour],
                strokeWeight: 2,
                clickable: false,
                zIndex: 1,
                path: GDouglasPeucker(path.j, 10),
                editable: false
            });
            
            if(polygonArray.length == 0) $('#undo-button').show();
            polygonArray.push(polygon);
         
        });
    }
    
    
    function beginDraw(){
                
        map.setOptions({
            draggable: false, 
            scrollwheel: false, 
            disableDoubleClickZoom: true
        });
        
        google.maps.event.addDomListener(map.getDiv(), 'mousedown', function(){
            drawFreeHand();
        });   
    }
    
    function endDraw(){
        
        map.setOptions({
            draggable: true, 
            scrollwheel: true, 
            disableDoubleClickZoom: false
        });
        
        google.maps.event.clearListeners(map.getDiv(), 'mousedown');
        
    }
    
    
    // draw type click handler
    $('.ind-draw').click(function(){
        if(!$(this).hasClass('draw-active')) {
            $('.ind-draw.draw-active').removeClass('draw-active');
            $(this).addClass('draw-active');
            
            if($(this).attr("id") == "pan-map"){           
                endDraw();
            }
            else {
                if($(this).attr("id") == "draw-flowers") selectedColour = 1;
                else if($(this).attr("id") == "draw-park") selectedColour = 2;
                else selectedColour = 0;            
                
                beginDraw();                    
            }
        }
    });
    
    // draw button click handler
    $('#draw-button').click(function(){
        $('#default-menu').hide();
        $('#draw-menu').show();
        $('#draw-types').show();      
        $('.draw-active').removeClass('draw-active');
        $('#pan-map').addClass('draw-active');
    });
    
    // cancel draw button click handler
    $('#cancel-button').click(function(){
        $('#draw-menu').hide();
        $('#draw-types').hide();
        $('#default-menu').show();
     
        $.each(polygonArray, function(key, val){
            val.setMap(null);
        });
        polygonArray = [];
        
        endDraw();
    });
    
    // submit draw button click handler
     $('#submit-button').click(function(){
        $('#draw-menu').hide();
        $('#draw-types').hide();
        $('#default-menu').show();
                        
        var polygonData = [];
        $.each(polygonArray, function(key, val){
            var indPolygonData = [];
            $.each(val.getPath().getArray(), function(key, val){
                indPolygonData.push({"lat": val.lat(), "lon": val.lng()});
            });
            polygonData.push({"type": selectedColour, "points": indPolygonData});
        });
        
        permanentPolygons = permanentPolygons.concat(polygonData);
        polygonArray = [];
        
        endDraw();

        $.ajax({
            type: "POST",
            url: "http://178.62.54.23:3000/post",
            data: JSON.stringify(polygonData),
            contentType: "text/plain",
            success: function(data){ }
        });
       
    });
    
    // undo draw button click handler
    $('#undo-button').click(function(){
        
        var polygon = polygonArray.pop();
        if(typeof polygon !== "undefined") polygon.setMap(null);
        if(polygonArray.length == 0) $('#undo-button').hide();
    });

    </script>
  </body>
</html>